name: CI/CD - Python Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  python-build-test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ========== ETAPA 1: BUILD ==========
    - name: Checkout del cÃ³digo
      uses: actions/checkout@v4
      
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Instalar dependencias (BUILD)
      run: |
        pip install -r requirements.txt
        echo "âœ… Dependencias de Python instaladas"
    
    # ========== ETAPA 2: TEST ==========
    - name: Ejecutar pruebas con pytest (TEST)
      run: |
        python -m pytest test_basic.py -v
        echo "âœ… Pruebas de Python ejecutadas exitosamente"
    
    - name: Verificar sintaxis del cÃ³digo
      run: |
        python -m py_compile app.py
        echo "âœ… Sintaxis de Python verificada"
    
    # ========== ETAPA 3: DEPLOY CON DOCKER ==========
    - name: Construir imagen Docker para Python
      run: |
        echo "ğŸ³ Construyendo imagen Docker para Python..."
        docker build -t python-app:latest .
        echo "âœ… Imagen Docker de Python construida"
    
    - name: Probar aplicaciÃ³n Python en contenedor
      run: |
        echo "ğŸš€ Ejecutando contenedor Python..."
        docker run -d --name python-test -p 5000:5000 python-app:latest
        sleep 5
        echo "ğŸ” Health check..."
        curl -f http://localhost:5000/health && echo "âœ… App Python funciona en Docker"
        docker stop python-test
        docker rm python-test
    
    - name: Simular despliegue en producciÃ³n
      run: |
        echo "ğŸ‰ Â¡DESPLIEGUE DE APLICACIÃ“N PYTHON EXITOSO!"
        echo "âœ… Build: Dependencias instaladas"
        echo "âœ… Test: Pruebas pytest exitosas"
        echo "âœ… Deploy: Contenedor Docker funcionando"
        echo "ğŸš€ AplicaciÃ³n Python lista para producciÃ³n"